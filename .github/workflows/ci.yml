name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint-and-typecheck:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    - run: npm ci
    - name: Typecheck
      run: npx tsc --noEmit
    - name: Lint
      run: npx eslint src --ext .ts,.tsx --max-warnings 0 || true

  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    - run: npm ci
    - name: Unit Tests
      run: node --max-old-space-size=4096 ./node_modules/.bin/vitest --run --coverage
    - name: Upload Coverage
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage/lcov.info
        fail_ci_if_error: false

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    - run: npm ci
    - name: Build
      run: npm run build
    - name: Bundle Size Analysis
      run: |
        echo "## Bundle Size Report" >> $GITHUB_STEP_SUMMARY
        echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        for f in dist/assets/*.js; do
          size=$(ls -lh "$f" | awk '{print $5}')
          name=$(basename "$f")
          echo "| $name | $size |" >> $GITHUB_STEP_SUMMARY
        done
        total=$(du -sh dist/assets | cut -f1)
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Total: $total**" >> $GITHUB_STEP_SUMMARY
    - name: Check Bundle Limits
      run: |
        # Main bundle should be under 500KB
        main_size=$(stat -f%z dist/assets/index-*.js 2>/dev/null || stat -c%s dist/assets/index-*.js)
        if [ "$main_size" -gt 512000 ]; then
          echo "::warning::Main bundle exceeds 500KB: $(($main_size / 1024))KB"
        fi
    - uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/
        retention-days: 7

  e2e:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    - run: npm ci
    - name: Install Playwright
      run: npx playwright install --with-deps chromium
    - uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist/
    - name: Run E2E Tests
      run: npx playwright test --project=chromium
    - uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: playwright-report
        path: playwright-report/

  lighthouse:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    - run: npm ci
    - uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist/
    - name: Serve & Lighthouse
      run: |
        npm install -g serve @lhci/cli
        serve -s dist -l 5000 &
        sleep 3
        lhci autorun --collect.url=http://localhost:5000 --assert.preset=lighthouse:recommended || true
    - name: Lighthouse Report
      run: |
        echo "## Lighthouse Scores" >> $GITHUB_STEP_SUMMARY
        if [ -f ".lighthouseci/lhr-*.json" ]; then
          cat .lighthouseci/lhr-*.json | jq -r '"| Performance | \(.categories.performance.score * 100)% |"' >> $GITHUB_STEP_SUMMARY || true
        fi
